<!DOCTYPE html>
<html>
<head>
  <title>Stock Quotes and Graphs</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Stock Quotes and Graphs</h1>
  <form id="apiKeyForm">
    <label for="apiKey">API Key: </label>
    <input type="text" id="apiKey" placeholder="Your Alpha Vantage API Key">
    <button type="button" onclick="saveApiKey()">Save API Key</button>
  </form>
  <label for="symbols">Stock Symbols (comma-separated): </label>
  <input type="text" id="symbols" placeholder="AAPL, MSFT">
  <label for="range">Time Range: </label>
  <select id="range">
    <option value="30">1 Month</option>
    <option value="90">3 Months</option>
    <option value="180">6 Months</option>
  </select>
  <button onclick="fetchAndGraph()">Fetch and Graph</button>
  <canvas id="stockChart"></canvas>

  <script>
    function saveApiKey() {
      const apiKeyInput = document.getElementById('apiKey');
      const apiKey = apiKeyInput.value;
      if (apiKey.trim() !== '') {
        localStorage.setItem('alphaVantageApiKey', apiKey);
        apiKeyInput.value = '';
        alert('API Key saved successfully!');
      } else {
        alert('Please provide a valid API Key.');
      }
    }

    function getSavedApiKey() {
      return localStorage.getItem('alphaVantageApiKey');
    }

    function daysAgo(date) {
      const now = new Date();
      const diff = now - date;
      const r = diff / (1000 * 60 * 60 * 24);
      return r;
    }

    async function fetchAndGraph() {
      const apiKey = getSavedApiKey();
      if (!apiKey) {
        alert('Please save your API Key first.');
        return;
      }

      const symbols = document.getElementById('symbols').value.split(',').map(symbol => symbol.trim());
      const range = parseInt(document.getElementById('range').value);

      const ctx = document.getElementById('stockChart').getContext('2d');
      const stockChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: []
        }
      });

      for (const symbol of symbols) {
        const response = await axios.get(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${apiKey}&outputsize=full`);
        const data = response.data['Time Series (Daily)'];

        const labels = [];
        const prices = [];

        for (let date in data) {
          labels.push(date);
          prices.push(parseFloat(data[date]['4. close']));
          if (daysAgo(new Date(date)) > (range + 1)) break;
        }

        labels.reverse();
        prices.reverse();

        stockChart.data.labels = labels;
        stockChart.data.datasets.push({
          label: `${symbol} Stock Price`,
          data: prices,
          borderColor: getRandomColor(),
          borderWidth: 1,
          fill: false
        });
      }

      stockChart.update();
    }

    function getRandomColor() {
      const letters = '0123456789ABCDEF';
      let color = '#';
      for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
      }
      return color;
    }
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }
    window.onload = function() {
      const urlQuotes = getQueryParam('quotes');
      if (urlQuotes) {
        document.getElementById('symbols').value = urlQuotes;
      }
    };
  </script>
</body>
</html>
